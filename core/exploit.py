import json, time, random

from core import engine
from core.ids import write
from core.blueteam import increase_trace
from core.ui import (
    slow_print,
    loading,
    RED,
    GREEN,
    YELLOW,
    RESET
)

DATA = "data"
TARGETS = f"{DATA}/targets.json"


# ===== GENERIC EXPLOIT STAGE =====
def stage(name, duration=1.2, fail_chance=0.1, trace=1):
    loading(name, duration)

    if random.random() < fail_chance:
        slow_print(f"{RED}[-] {name} failed{RESET}", 0.02)
        increase_trace(trace)
        write(f"{name} failed", "MEDIUM")
        return False

    slow_print(f"{GREEN}[+] {name} success{RESET}", 0.02)
    return True


# ===== MAIN EXPLOIT =====
def exploit(t):
    if not engine.current_target:
        engine.current_target = None

    targets = json.load(open(TARGETS))

    if t not in targets:
        slow_print(f"{RED}[!] target not found{RESET}", 0.02)
        return

    slow_print(f"{YELLOW}[*] initiating attack on {t}{RESET}", 0.02)

    loading("scanning target", 1.5)
    loading("weaponizing exploit", 1.2)
    loading("deploying payload", 1.8)

    # IDS event (sangat noisy)
    write("exploit chain initiated", "HIGH")

    time.sleep(0.3)

    # ===== STAGE 1: RECON =====
    if not stage(
        "reconnaissance",
        duration=1.2,
        fail_chance=0.05,
        trace=1
    ):
        slow_print("[!] exploit aborted during recon", 0.02)
        return

    # ===== STAGE 2: INITIAL ACCESS =====
    if not stage(
        "initial access",
        duration=1.5,
        fail_chance=0.15,
        trace=2
    ):
        slow_print("[!] exploit chain broken", 0.02)
        return

    # ===== STAGE 3: PRIVILEGE ESCALATION =====
    if not stage(
        "privilege escalation",
        duration=1.7,
        fail_chance=0.2,
        trace=3
    ):
        slow_print("[!] privilege escalation failed", 0.02)
        return

    # ===== SUCCESS =====
    engine.current_target = t
    engine.cwd = "/"
    engine.logged_user = None

    write("shell access obtained", "HIGH")

    slow_print(f"{GREEN}[+] shell access granted{RESET}", 0.02)
    slow_print("type 'ls', 'cd', 'cat', 'netmap'", 0.01)
